"use strict";
// Copyright (c) Microsoft Corporation.
// Licensed under the MIT license.
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProjectVersionCheckerMW = void 0;
const tslib_1 = require("tslib");
const teamsfx_api_1 = require("@microsoft/teamsfx-api");
const globalVars_1 = require("../globalVars");
const localizeUtils_1 = require("../../common/localizeUtils");
const projectSettingsLoader_1 = require("./projectSettingsLoader");
const semver_1 = tslib_1.__importDefault(require("semver"));
let userCancelFlag = false;
const methods = new Set(["getProjectConfig", "checkPermission"]);
const currentSupportProjectVersion = "< 3.0.0";
const ProjectVersionCheckerMW = async (ctx, next) => {
    if ((await needToShowUpdateDialog(ctx)) && checkMethod(ctx)) {
        showDialog(ctx);
    }
    await next();
};
exports.ProjectVersionCheckerMW = ProjectVersionCheckerMW;
async function needToShowUpdateDialog(ctx) {
    const lastArg = ctx.arguments[ctx.arguments.length - 1];
    const inputs = lastArg === ctx ? ctx.arguments[ctx.arguments.length - 2] : lastArg;
    const loadRes = await projectSettingsLoader_1.loadProjectSettings(inputs, true);
    if (loadRes.isErr()) {
        ctx.result = teamsfx_api_1.err(loadRes.error);
        return false;
    }
    const projectSettings = loadRes.value;
    const currentProjectVersion = projectSettings.version;
    if (currentProjectVersion) {
        if (!semver_1.default.satisfies(currentProjectVersion, currentSupportProjectVersion)) {
            return true;
        }
    }
    return false;
}
async function showDialog(ctx) {
    const lastArg = ctx.arguments[ctx.arguments.length - 1];
    const inputs = lastArg === ctx ? ctx.arguments[ctx.arguments.length - 2] : lastArg;
    if (inputs.platform === teamsfx_api_1.Platform.VSCode) {
        await (globalVars_1.TOOLS === null || globalVars_1.TOOLS === void 0 ? void 0 : globalVars_1.TOOLS.ui.showMessage("warn", localizeUtils_1.getLocalizedString("core.projectVersionChecker.vscodeUseNewVersion"), false, "OK"));
    }
    else if (inputs.platform === teamsfx_api_1.Platform.CLI) {
        globalVars_1.TOOLS === null || globalVars_1.TOOLS === void 0 ? void 0 : globalVars_1.TOOLS.logProvider.warning(localizeUtils_1.getLocalizedString("core.projectVersionChecker.cliUseNewVersion"));
    }
}
function checkMethod(ctx) {
    if (ctx.method && methods.has(ctx.method) && userCancelFlag)
        return false;
    userCancelFlag = ctx.method != undefined && methods.has(ctx.method);
    return true;
}
//# sourceMappingURL=projectVersionChecker.js.map