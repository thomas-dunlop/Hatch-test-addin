"use strict";
// Copyright (c) Microsoft Corporation.
// Licensed under the MIT license.
Object.defineProperty(exports, "__esModule", { value: true });
exports.needMigrateToAadManifest = exports.generateAadManifest = exports.permissionsToRequiredResourceAccess = void 0;
const tslib_1 = require("tslib");
const path_1 = tslib_1.__importDefault(require("path"));
const tools_1 = require("../../common/tools");
const fs_extra_1 = tslib_1.__importDefault(require("fs-extra"));
const plugins_1 = require("../../plugins");
const localizeUtils_1 = require("../../common/localizeUtils");
const globalVars_1 = require("../globalVars");
const generateAadManifestTemplate_1 = require("../generateAadManifestTemplate");
function permissionsToRequiredResourceAccess(permissions) {
    const result = [];
    try {
        permissions.forEach((permission) => {
            const res = {
                resourceAppId: permission.resource,
                resourceAccess: permission.application
                    .map((item) => {
                    return { id: item, type: "Role" };
                })
                    .concat(permission.delegated.map((item) => {
                    return { id: item, type: "Scope" };
                })),
            };
            result.push(res);
        });
    }
    catch (err) {
        return undefined;
    }
    return result;
}
exports.permissionsToRequiredResourceAccess = permissionsToRequiredResourceAccess;
async function generateAadManifest(projectPath, projectSettingsJson) {
    const permissionFilePath = path_1.default.join(projectPath, "permissions.json");
    // add aad.template.file
    const permissions = (await fs_extra_1.default.readJson(permissionFilePath));
    const requiredResourceAccess = permissionsToRequiredResourceAccess(permissions);
    if (!requiredResourceAccess) {
        globalVars_1.TOOLS === null || globalVars_1.TOOLS === void 0 ? void 0 : globalVars_1.TOOLS.logProvider.warning(localizeUtils_1.getLocalizedString("core.aadManifestMigration.ParsePermissionsFailedWarning"));
    }
    await generateAadManifestTemplate_1.generateAadManifestTemplate(projectPath, projectSettingsJson, requiredResourceAccess, true);
}
exports.generateAadManifest = generateAadManifest;
async function needMigrateToAadManifest(ctx) {
    var _a, _b;
    try {
        if (!tools_1.isAadManifestEnabled()) {
            return false;
        }
        const inputs = ctx.arguments[ctx.arguments.length - 1];
        if (!inputs.projectPath) {
            return false;
        }
        const fxExist = await fs_extra_1.default.pathExists(path_1.default.join(inputs.projectPath, ".fx"));
        if (!fxExist) {
            return false;
        }
        const aadManifestTemplateExist = await fs_extra_1.default.pathExists(path_1.default.join(inputs.projectPath, "templates", "appPackage", "aad.template.json"));
        if (aadManifestTemplateExist) {
            return false;
        }
        const permissionFileExist = await fs_extra_1.default.pathExists(path_1.default.join(inputs.projectPath, "permissions.json"));
        if (!permissionFileExist) {
            return false;
        }
        const projectSettingsJson = await fs_extra_1.default.readJson(path_1.default.join(inputs.projectPath, ".fx", "configs", "projectSettings.json"));
        const aadPluginIsActive = (_b = (_a = projectSettingsJson.solutionSettings) === null || _a === void 0 ? void 0 : _a.activeResourcePlugins) === null || _b === void 0 ? void 0 : _b.includes(plugins_1.PluginNames.AAD);
        if (!aadPluginIsActive) {
            return false;
        }
        return true;
    }
    catch (err) {
        return false;
    }
}
exports.needMigrateToAadManifest = needMigrateToAadManifest;
//# sourceMappingURL=MigrationUtils.js.map