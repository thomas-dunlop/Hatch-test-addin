"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.publishApplication = void 0;
const teamsfx_api_1 = require("@microsoft/teamsfx-api");
const lodash_1 = require("lodash");
const typedi_1 = require("typedi");
const constants_1 = require("../../../../common/constants");
const localizeUtils_1 = require("../../../../common/localizeUtils");
const projectSettingsHelper_1 = require("../../../../common/projectSettingsHelper");
const constants_2 = require("../constants");
const ResourcePluginContainer_1 = require("../ResourcePluginContainer");
const executor_1 = require("./executor");
const utils_1 = require("./utils");
async function publishApplication(ctx, inputs, envInfo, tokenProvider) {
    var _a;
    const inAzureProject = utils_1.isAzureProject(utils_1.getAzureSolutionSettings(ctx));
    const provisioned = envInfo.state[constants_2.GLOBAL_CONFIG][constants_2.SOLUTION_PROVISION_SUCCEEDED];
    if (inAzureProject && !provisioned) {
        return teamsfx_api_1.err(new teamsfx_api_1.UserError(constants_2.SolutionSource, constants_2.SolutionError.CannotDeployBeforeProvision, localizeUtils_1.getDefaultString("core.NotProvisionedNotice", ctx.projectSetting.appName), localizeUtils_1.getLocalizedString("core.NotProvisionedNotice", ctx.projectSetting.appName)));
    }
    const pureExistingApp = projectSettingsHelper_1.isExistingTabApp(ctx.projectSetting);
    // for minimized teamsfx project, there is only one plugin (app studio)
    const plugins = pureExistingApp
        ? [typedi_1.Container.get(ResourcePluginContainer_1.ResourcePluginsV2.AppStudioPlugin)]
        : utils_1.getSelectedPlugins(ctx.projectSetting);
    const thunks = plugins
        .filter((plugin) => !lodash_1.isUndefined(plugin.publishApplication))
        .map((plugin) => {
        return {
            pluginName: `${plugin.name}`,
            taskName: "publishApplication",
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            thunk: () => plugin.publishApplication(ctx, inputs, envInfo, tokenProvider),
        };
    });
    ctx.logProvider.info(localizeUtils_1.getLocalizedString("core.publish.startNotice", constants_1.PluginDisplayName.Solution));
    const result = await executor_1.executeConcurrently(thunks, ctx.logProvider);
    if (result.kind !== "success") {
        const msg = localizeUtils_1.getLocalizedString("core.publish.failNotice", ctx.projectSetting.appName);
        (_a = ctx.logProvider) === null || _a === void 0 ? void 0 : _a.info(msg);
        return teamsfx_api_1.err(result.error);
    }
    return teamsfx_api_1.ok(teamsfx_api_1.Void);
}
exports.publishApplication = publishApplication;
//# sourceMappingURL=publish.js.map